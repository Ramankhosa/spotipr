# üß© Patent Drafting Module SRS (Indian Patent Annexure)

## System Goal
Convert a user-supplied *patent idea* into a **complete Indian Patent Annexure** (text + PlantUML diagrams with numbered references) using staged LLM + user-uploaded figure workflow, compliant with Indian Patent Office Form-2 complete specification requirements.

## Compliance Requirements (IPO Form-2 Complete Specification)
- **Title**: ‚â§ 15 words
- **Best Method**: Required subsection in Detailed Description (s.10(4))
- **Abstract**: ‚â§ 150 words, must commence with the title
- **Claims**: Start on new page, numbered consecutively, with every-fifth-line numbering
- **Drawings**: Separate sheets (not embedded), with Brief Description in specification
- **Formatting**: A4 paper, margins (top/left 4cm, bottom/right 3cm), page numbering, line-numbering every 5th line
- **Preamble**: Form-2 complete-spec preamble: "The following specification particularly describes the invention and the manner in which it is to be performed."

## üî∑ STAGE 1 ‚Äì Idea Intake & Normalization (UI: "Idea Entry" Page)

### UI Components
1. **Text Entry Field** ‚Äì large textarea for user to paste or type the invention idea.
   - Placeholder: "Describe your invention in detail‚Ä¶"
2. **Upload Option** ‚Äì accept `.txt` or `.docx` containing the idea.
3. **Title Field** ‚Äì with validation (‚â§ 15 words)
4. **Auto Structure Button** ‚Äì triggers LLM normalization into structured fields.
5. **Manual Field Editor** ‚Äì collapsible panels for:
   - Problem & Context
   - Objectives & Key Features
   - Components / Modules
   - Inputs / Outputs
   - Working Example / Use Case
   - Advantages over prior art
   - Variants / Embodiments
   - Terminology
   - Best Method (if known)

### Data Origin
- User text ‚Üí LLM (`Idea Normalizer`) ‚Üí JSON object `{title, problem, objectives, components, logic, outputs, variants, bestMethod, etc.}`
- Stored as `IdeaRecord` in DB with tenant/project context.

### UI Remarks
- Title validation: ‚â§ 15 words enforcement
- After LLM response, show side-by-side comparison
- User can manually correct missing or ambiguous entries
- "Proceed to Components" button enabled once all required fields filled

## üî∑ STAGE 2 ‚Äì Component & Numeral Assignment (UI: "Component Planner" Page)

### UI Components
1. **Component Table**
   - Columns: *Name*, *Type (select)*, *Short Description*, *Assigned Numeral*
   - Editable; user can add, delete, reorder.
2. **Auto Assign Numerals Button** ‚Äì runs Numeral Allocator logic.
3. **View Reserved Ranges Panel**
   - Display ranges (100-series top modules, 200-series submodules, etc.)
4. **Generate Reference Map Button**
   - Shows live table with numeral assignments

### Data Origin
- Components pulled from normalized idea (Stage 1).
- Numerals auto-assigned via deterministic allocator using category rules.
- Stored as `ReferenceMap` object with tenant isolation.

### UI Remarks
- Changes trigger auto-saving with metering tracking
- "Next: Diagram Planner" unlocked once numerals are unique and validated
- ATI hierarchy enforcement for access control

## üî∑ STAGE 3 ‚Äì Diagram Planning (UI: "Figure Planner" Page)

### UI Components
1. **Figure List Panel**
   - Default: Fig. 1 ‚Äì System Architecture, Fig. 2 ‚Äì Data Flow, Fig. 3 ‚Äì Process Sequence.
   - Add / Delete Figure buttons.
2. **Component Selector (per Figure)**
   - Drag components from Reference Map into each figure.
3. **Edge Builder Tool**
   - Draw arrows between selected components; label them ("signal", "data flow", etc.)
4. **Preview Panel (Text Only)**
   - Shows draft PlantUML syntax outline

### Data Origin
- Uses `ReferenceMap` and user selections to create a `FigurePlan` JSON:
  `{figure_no, title, nodes:[ref#], edges:[(ref1,ref2,label)]}`.
- Metered storage with tenant limits.

### UI Remarks
- No images rendered here‚Äîonly PlantUML text preview.
- On save: `FigurePlan` stored; "Generate UML Code" enabled.

## üî∑ STAGE 4 ‚Äì PlantUML Code Generation (UI: "Diagram Generator" Page)

### UI Components
1. **Read-only Text Editor (syntax highlighted)**
   - Displays full PlantUML code generated from the `FigurePlan`.
   - Button: "Copy to PlantUML Server".
2. **Instructions Box**
   - Links to PlantUML Online Renderer
3. **Upload Rendered Images Section**
   - File input (accept `.png` / `.svg` / `.jpg`).
   - Validation ensures file names match figure numbers (`Fig.1.png`, etc.).
   - Checksum validation for integrity.

### Data Origin
- Generated by local code ‚Üí stored as `DiagramSource` with `plantuml_text`.
- Uploaded files stored under same IDs with checksum and tenant context.

### UI Remarks
- Upon successful image upload, preview thumbnails appear alongside PlantUML text.
- "Proceed to Draft Generation" button activated once all figures uploaded.

## üî∑ STAGE 5 ‚Äì Patent Draft Generation (UI: "Annexure Draft" Page)

### UI Components
1. **Section Tabs**:
   - Title
   - Field of Invention
   - Background
   - Summary
   - Brief Description of Drawings
   - Detailed Description (with Best Method subsection)
   - Claims
   - Abstract
   - List of Numerals

2. **Draft Viewer (center panel)**
   - Shows auto-generated text with reference numerals inline `(210)`.

3. **Side Panel:**
   - **Reference Map** (hover highlights all mentions in draft)
   - **Figures Panel** (thumbnails clickable ‚Üí scrolls to referenced paragraph)

4. **Generate Draft Button**
   - Calls LLM `Annexure Generator` with metered token tracking

### Data Origin
- Draft sections generated via LLM ‚Üí stored in `AnnexureDraft`.
- Text automatically integrates numerals and figure citations.
- Abstract prefixed with title, ‚â§150 words enforcement.

### UI Remarks
- Each section editable (inline rich text editor).
- Auto-highlighting of all reference numerals.
- Validation banner for consistency checking.

## üî∑ STAGE 6 ‚Äì Consistency & Validation (UI: "Review & Fix" Page)

### UI Components
1. **Validation Report Table**
   - Columns: *Numeral*, *Appears in Text?*, *Appears in Figure?*, *Count of Mentions*, *Status*.
2. **Quick Fix Buttons**
   - "Add to List of Numerals"
   - "Remove from Draft"
   - "Rename Component" (propagates everywhere)
3. **Conflict Resolver**
   - Shows renumber conflicts; provides one-click renumber suggestion.

### Data Origin
- Backend runs `ConsistencyChecker`:
  - Compare numerals in text vs figures vs ReferenceMap.
- Results stored for auditing and compliance.

### UI Remarks
- All corrections propagate instantly to draft and figure metadata.
- "Final Export" enabled only when all conflicts resolved.

## üî∑ STAGE 7 ‚Äì Export & Versioning (UI: "Export Center" Page)

### UI Components
1. **File Type Toggles**
   - DOCX / PDF / ZIP bundle (includes `.docx` + figures)
2. **Version History Panel**
   - Displays prior drafts with timestamps, differences, and revert options.
3. **Download Summary**
   - "Indian Patent Annexure (Complete)"

### Data Origin
- `AnnexureDraft` + verified figures ‚Üí export pipeline.
- PlantUML sources embedded in ZIP for reproducibility.
- Form-2 formatting applied: A4, margins, line numbering, preamble.

### UI Remarks
- Exported PDF uses figure captions as per IPO guidelines
- Drawings on separate sheets, not embedded

## üî∑ STAGE 8 ‚Äì Optional Post-Processing

### UI Components
1. **"Ask LLM for Review" Button**
   - Optional: generate a summary of novelty and risk zones (metered).
2. **"Generate Alternate Embodiment" Button**
   - LLM drafts a second embodiment with minor changes (for dependent claim scaffolding).

## ‚öôÔ∏è Process Flow Summary

| Step | UI Page           | Main Action                                | Source/Logic      | Output Object        |
| ---- | ----------------- | ------------------------------------------ | ----------------- | -------------------- |
| 1    | Idea Entry        | Input free text, normalize                 | LLM Normalizer    | `IdeaRecord`         |
| 2    | Component Planner | Define modules, assign numerals            | Numeral Allocator | `ReferenceMap`       |
| 3    | Figure Planner    | Select components, draw relations          | User input        | `FigurePlan`         |
| 4    | Diagram Generator | Generate PlantUML, upload images           | PlantUML builder  | `DiagramSource`      |
| 5    | Annexure Draft    | LLM draft creation                         | LLM Draft Writer  | `AnnexureDraft`      |
| 6    | Review & Fix      | Consistency check, corrections             | Checker Engine    | Updated JSONs        |
| 7    | Export Center     | Generate PDF/DOCX/ZIP                      | Export pipeline   | Final Annexure       |
| 8    | Post-Processing   | Optional LLM Review/Variants               | LLM Reviewer      | Summary or Alt Draft |

## üß† Key Data Flow
```
User Idea
   ‚Üì
[LLM Idea Normalizer] ‚Üí structured idea (IdeaRecord)
   ‚Üì
[Component & Numeral Allocator] ‚Üí ReferenceMap
   ‚Üì
[User Figure Plan] ‚Üí FigurePlan
   ‚Üì
[PlantUML Builder] ‚Üí plantuml_text (user uploads images)
   ‚Üì
[LLM Annexure Writer] ‚Üí Draft sections with numerals
   ‚Üì
[Consistency Checker] ‚Üí validation_report
   ‚Üì
[Exporter] ‚Üí DOCX/PDF/ZIP (Form-2 compliant)
```

## ‚úÖ Acceptance Criteria
1. **Full pipeline runs end-to-end with no manual JSON edits.**
2. **All numerals consistent across draft and figures.**
3. **PlantUML code deterministic and reproducible from stored JSON.**
4. **Draft includes all Indian Patent annexure sections with IPO compliance.**
5. **User-uploaded figures correctly validated against figure IDs.**
6. **Exported bundle ready for attorney/legal polishing with Form-2 formatting.**
7. **ATI hierarchy, LLM metering, and tenant controls fully integrated.**
8. **Start Draft buttons accessible from analyst home and patent tiles.**

## üöÄ Implementation Requirements
- **UI Flow**: 8 pages as defined above with modern, vibrant design
- **LLM Integration**: Metered calls for normalization, drafting, and review
- **Numeral Management**: Deterministic allocator with consistency checker
- **PlantUML Workflow**: Code generation + user-uploaded image validation
- **Export Pipeline**: IPO Form-2 compliant PDF/DOCX generation
- **Security**: ATI hierarchy enforcement, tenant isolation, metering controls
- **Persistence**: Full state management with rollback capabilities
- **Validation**: Comprehensive testing and consistency validation

## üîß Technical Architecture
- **Frontend**: Next.js pages with TypeScript, modern UI components
- **Backend**: API routes with Prisma database integration
- **LLM**: Metered gateway integration with multiple providers
- **Storage**: File uploads for figures with checksum validation
- **Export**: PDF/DOCX generation with IPO formatting requirements
- **Security**: ATI hierarchy middleware, tenant context enforcement
